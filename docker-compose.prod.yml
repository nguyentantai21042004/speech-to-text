# =============================================================================
# Production Docker Compose
# =============================================================================
# Optimized for production deployment with:
# - 1 core per container (horizontal scaling strategy)
# - No hardcoded credentials
# - Health checks aligned with K8s probes
#
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#
# Required environment variables (set in .env or export):
#   - MINIO_ENDPOINT
#   - MINIO_ACCESS_KEY
#   - MINIO_SECRET_KEY
#   - INTERNAL_API_KEY
# =============================================================================

services:
  api:
    build:
      context: .
      dockerfile: cmd/api/Dockerfile
    image: localhost:5001/stt-api:optimized
    container_name: stt-api-prod
    restart: unless-stopped
    ports:
      - "8000:8000"
    
    environment:
      # Application
      APP_NAME: "Speech-to-Text API"
      APP_VERSION: "1.0.0"
      ENVIRONMENT: "production"
      DEBUG: "false"

      # API Configuration
      API_HOST: "0.0.0.0"
      API_PORT: "8000"
      API_WORKERS: "2"
      MAX_UPLOAD_SIZE_MB: "500"

      # Whisper Configuration (1 core optimized)
      WHISPER_MODEL_SIZE: "${WHISPER_MODEL_SIZE:-base}"
      WHISPER_LANGUAGE: "${WHISPER_LANGUAGE:-vi}"
      WHISPER_N_THREADS: "0"  # Auto-detect (recommended for 1 core)
      
      # Chunking Configuration
      WHISPER_CHUNK_ENABLED: "true"
      WHISPER_CHUNK_DURATION: "30"
      WHISPER_CHUNK_OVERLAP: "1"

      # MinIO Configuration (from environment)
      MINIO_ENDPOINT: "${MINIO_ENDPOINT}"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY}"

      # Security
      INTERNAL_API_KEY: "${INTERNAL_API_KEY}"
      
      # Timeouts
      TRANSCRIBE_TIMEOUT_SECONDS: "90"

      # Logging
      LOG_LEVEL: "INFO"
      LOG_FILE: "logs/stt.log"

    volumes:
      - ./logs:/app/logs
      # Cache downloaded Whisper artifacts
      - whisper_library_base:/app/models/whisper_base_xeon
      - whisper_library_small:/app/models/whisper_small_xeon
      - whisper_library_medium:/app/models/whisper_medium_xeon
    
    # Resource limits (1 core strategy - matches K8s deployment)
    deploy:
      resources:
        limits:
          cpus: '2'      # 2 cores burst
          memory: 2G     # 2GB max
        reservations:
          cpus: '1'      # 1 core guaranteed
          memory: 1G     # 1GB reserved
    
    networks:
      - stt-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  stt-network:
    driver: bridge

volumes:
  whisper_library_base:
    driver: local
  whisper_library_small:
    driver: local
  whisper_library_medium:
    driver: local
