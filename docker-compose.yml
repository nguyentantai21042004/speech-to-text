services:
  # ========================================
  # API Service
  # ========================================
  api:
    build:
      context: .
      dockerfile: cmd/api/Dockerfile
    container_name: stt-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Application
      APP_NAME: ${APP_NAME:-Speech-to-Text API}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      DEBUG: ${DEBUG:-True}

      # API
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}
      API_RELOAD: ${API_RELOAD:-False}
      API_WORKERS: ${API_WORKERS:-1}
      MAX_UPLOAD_SIZE_MB: ${MAX_UPLOAD_SIZE_MB:-500}

      # Storage
      TEMP_DIR: ${TEMP_DIR:-/tmp/stt_processing}

      # Whisper
      WHISPER_EXECUTABLE: ${WHISPER_EXECUTABLE:-/app/whisper/bin/whisper-cli}
      WHISPER_MODELS_DIR: ${WHISPER_MODELS_DIR:-/app/whisper/models}
      DEFAULT_WHISPER_MODEL: ${DEFAULT_WHISPER_MODEL:-medium}
      WHISPER_LANGUAGE: ${WHISPER_LANGUAGE:-vi}
      WHISPER_MODEL: ${WHISPER_MODEL:-base}

      # Whisper Library Settings (Dynamic Model Loading)
      WHISPER_MODEL_SIZE: ${WHISPER_MODEL_SIZE:-base}  # Options: base (default), small, medium
      # Model directory: models/ (artifacts in models/whisper_base_xeon/, etc.)
      WHISPER_ARTIFACTS_DIR: ${WHISPER_ARTIFACTS_DIR:-models}

      # MinIO Configuration (for artifact download)
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://172.16.19.115:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      
      # Whisper Flags
      WHISPER_MAX_CONTEXT: ${WHISPER_MAX_CONTEXT:-0}
      WHISPER_NO_SPEECH_THOLD: ${WHISPER_NO_SPEECH_THOLD:-0.7}
      WHISPER_ENTROPY_THOLD: ${WHISPER_ENTROPY_THOLD:-2.6}
      WHISPER_LOGPROB_THOLD: ${WHISPER_LOGPROB_THOLD:--0.8}
      WHISPER_NO_FALLBACK: ${WHISPER_NO_FALLBACK:-true}
      WHISPER_SUPPRESS_REGEX: ${WHISPER_SUPPRESS_REGEX:-}

      # Processing
      CHUNK_TIMEOUT: ${CHUNK_TIMEOUT:-300}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FILE: ${LOG_FILE:-logs/stt.log}

    volumes:
      - ./logs:/app/logs
      - whisper_models:/app/whisper/models
      # Cache downloaded Whisper library artifacts between restarts
      # New location: models/ directory (matches WHISPER_ARTIFACTS_DIR=models)
      - whisper_library_base:/app/models/whisper_base_xeon
      - whisper_library_small:/app/models/whisper_small_xeon
      - whisper_library_medium:/app/models/whisper_medium_xeon
    networks:
      - stt-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s



networks:
  stt-network:
    driver: bridge

volumes:
  whisper_models:
    driver: local
  whisper_library_base:
    driver: local
  whisper_library_small:
    driver: local
  whisper_library_medium:
    driver: local