services:
  # ========================================
  # Development API Service (for macOS)
  # ========================================
  # This mounts your source code so you can edit locally
  # and run in Linux container (required for .so libraries)
  api-dev:
    platform: linux/amd64  # Force x86_64 for Whisper .so libraries
    image: python:3.12-slim-bookworm
    container_name: stt-api-dev
    restart: unless-stopped
    ports:
      - "8000:8000"
    working_dir: /app
    
    # Mount entire source directory
    volumes:
      - .:/app
      - whisper_models:/app/whisper/models
      - whisper_library_small:/app/whisper_small_xeon
      - whisper_library_medium:/app/whisper_medium_xeon
      # Cache pip packages
      - pip_cache:/root/.cache/pip
    
    environment:
      # Application
      APP_NAME: "Speech-to-Text API"
      APP_VERSION: "1.0.0"
      ENVIRONMENT: "development"
      DEBUG: "True"

      # API
      API_HOST: "0.0.0.0"
      API_PORT: "8000"
      API_RELOAD: "True"
      API_WORKERS: "1"
      MAX_UPLOAD_SIZE_MB: "500"

      # Storage
      TEMP_DIR: "/tmp/stt_processing"

      # Whisper Library Settings (base = default, balanced performance)
      WHISPER_MODEL_SIZE: "${WHISPER_MODEL_SIZE:-base}"
      WHISPER_ARTIFACTS_DIR: "."
      
      # Library path for Whisper shared libraries
      LD_LIBRARY_PATH: "/app/whisper_base_xeon:/app/whisper_small_xeon:/app/whisper_medium_xeon"
      
      # MinIO Configuration
      MINIO_ENDPOINT: "${MINIO_ENDPOINT:-http://172.16.19.115:9000}"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY:-minioadmin}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY:-hcmut2025}"

      # Whisper Settings
      WHISPER_EXECUTABLE: "/app/whisper/bin/whisper-cli"
      WHISPER_MODELS_DIR: "/app/whisper/models"
      WHISPER_LANGUAGE: "vi"
      WHISPER_MODEL: "base"
      WHISPER_N_THREADS: "${WHISPER_N_THREADS:-0}"  # 0=auto (min(cpu_count, 8)), or set explicit value

      # Chunking Configuration (for long audio processing)
      WHISPER_CHUNK_ENABLED: "${WHISPER_CHUNK_ENABLED:-true}"
      WHISPER_CHUNK_DURATION: "${WHISPER_CHUNK_DURATION:-30}"  # seconds
      WHISPER_CHUNK_OVERLAP: "${WHISPER_CHUNK_OVERLAP:-1}"     # seconds

      # Whisper Flags
      WHISPER_MAX_CONTEXT: "0"
      WHISPER_NO_SPEECH_THOLD: "0.7"
      WHISPER_ENTROPY_THOLD: "2.6"
      WHISPER_LOGPROB_THOLD: "-0.8"
      WHISPER_NO_FALLBACK: "true"

      # Logging
      LOG_LEVEL: "INFO"
      LOG_FILE: "logs/stt.log"

      # API Security & Timeouts
      INTERNAL_API_KEY: "${INTERNAL_API_KEY:-your-api-key-here}"
      TRANSCRIBE_TIMEOUT_SECONDS: "90"

      # Python
      PYTHONPATH: "/app"
      PYTHONUNBUFFERED: "1"
    
    # Run startup script
    command: ["/bin/bash", "/app/scripts/dev-startup.sh"]
    
    networks:
      - stt-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  stt-network:
    driver: bridge

volumes:
  whisper_models:
    driver: local
  whisper_library_base:
    driver: local
  whisper_library_small:
    driver: local
  whisper_library_medium:
    driver: local
  pip_cache:
    driver: local
